---
title: "Test 2"
output:
  pdf_document: default
  html_notebook: default
fontsize: 9pt
---


Loading the packages first
```{r setoptions, echo=TRUE }

library(pacman)
    p_load(tidyverse,dplyr, lavaan, psych, knitr, lme4, lmerTest, multilevel, nlme, lattice, sjPlot, ggplot2,cowplot, magrittr, broom, Metrics, pbkrtest, mlmRev, influence.ME, gridExtra, semPlot, plyr)
    
```
Question 1 â€“ Structural Equation Modeling

loading data
```{r loaddata, mysize = TRUE, message = FALSE, size="\\scriptsize"}

data <- readRDS("peru2.RDS")  

```

Making variables for the path analysis for SEM. I would like to predict risky/antisocial behaviour using self-efficacy, early life SES (round 1 and 2), mental health and agency
```{r}

#   SES (Using the following variables: Housing quality, Access to services, Consumer durables)
    data$hq_r12<-data$hq_r12/3
    data$sv_r12<-data$sv_r12/3
    data$cd_r12<-data$cd_r12/3
    data$ses_scale<-data$hq_r12+data$sv_r12+data$cd_r12
    
#   self-efficacy
    data$self_eff1<-(data$self_eff1)/8    
    data$self_eff2<-(data$self_eff2)/8  
    data$self_eff3<-(data$self_eff3)/8
    data$self_eff4<-(data$self_eff4)/8
    data$self_eff5<-(data$self_eff5)/8
    data$self_eff6<-(data$self_eff6)/8
    data$self_eff7<-(data$self_eff7)/8
    data$self_eff8<-(data$self_eff8)/8
    data$self_efficacy_scale<-(data$self_eff1 + data$self_eff2 + data$self_eff3 + data$self_eff4 + data$self_eff5 + data$self_eff6 + data$self_eff7 + data$self_eff8)
    
#   agency
    data$agency1<-data$agency1/4
    data$agency2<-data$agency2/4
    data$agency3<-data$agency3/4
    data$agency4<-data$agency4/4
    data$agency_scale<-data$agency1+data$agency2+data$agency3+data$agency4
    
#   mental wellness
    data$sdq1<-data$sdq1/5
    data$sdq2<-data$sdq2/5
    data$sdq3<-data$sdq3/5
    data$sdq4<-data$sdq4/5
    data$sdq5<-data$sdq5/5
    data$mental_wellness_scale<-data$sdq1+data$sdq2+data$sdq3+data$sdq4+data$sdq5
    
#   anti-social, or risk-taking behaviour at Round 5 
    
    data$FRNSMKR5<-data$FRNSMKR5/9 #Have friends who smoke   
    data$FRNALCR5<-data$FRNALCR5/9 #Have friends who use alcohol
    data$YOUALCR5<-data$YOUALCR5/9 #Uses alcohol 
    data$BEATEN<-data$BEATEN/9     #Beaten up by friends, strangers, teachers, parents 
    data$ARRSTDR5<-data$ARRSTDR5/9 #Has been arrested
    data$FRNGNGR5<-data$FRNGNGR5/9 #Has friends in gang
    data$MEMGNGR5<-data$MEMGNGR5/9 #Is a member of a gang
    data$CRYWPNR5<-data$CRYWPNR5/9 #Has carried a weapon
    data$NUMPRTR5<-data$NUMPRTR5/9 #Number of sex partners had
    data$risky_behaviour_scale<-(data$FRNSMKR5 + data$FRNALCR5 + data$YOUALCR5 + data$BEATEN + data$ARRSTDR5 + data$FRNGNGR5 + data$MEMGNGR5 + data$CRYWPNR5 + data$NUMPRTR5)
```
 Defining path model
```{r}

pathm1 <- '
      risky_behaviour_scale ~ self_efficacy_scale
      mental_wellness_scale ~ self_efficacy_scale

'
#Fitting and summarising the model
prejpathfit1 <- sem(pathm1, data = data)
summary(prejpathfit1, fit.measures = T) 

```
 
CFI and TLI are > .09 which shows that the model has a good fit, The model is  shows a good fit, not too sure about the RMSEA, p-value =Na, might need to compare to another model


Now drawing model using package semPlot
```{r}
semPlot::semPaths(prejpathfit1, what = "est", layout = "spring")
```
Our model is telling us that self efficacy and mental wellness are predictors of risky behaviours with self-efficacy also predicting mental illness

Defining path model 2

```{r predicttree, mysize = TRUE, warning=FALSE,  size="\\scriptsize", fig.height=3}

pathm2 <- '
      risky_behaviour_scale ~ self_efficacy_scale + mental_wellness_scale
      mental_wellness_scale ~ self_efficacy_scale + agency_scale
      self_efficacy_scale ~  agency_scale 

'  

#Fitting and summarising model
prejpathfit2 <- sem(pathm2, data = data)
summary(prejpathfit2, fit.measures = T) 

#comparing this model to our first model
anova(prejpathfit2, prejpathfit1) 
```

Now plotting this model
```{r}
semPlot::semPaths(prejpathfit2, what = "est", layout = "spring")
```
Let's take a closer look at the residuals as our new model as the AIC is higher than the first model's one and the RMSEA p-value is not significant
```{r}
      resid(prejpathfit2, type = "normalized")
      modificationindices(prejpathfit2)

```
we can see correlation between the risky behaviour scale and the mental wellness and self-efficacy scales
now lets respecify the model to allow correlations between the error terms in each scale 
```{r mysize = TRUE, warning=FALSE,  size="\\scriptsize"}
  
  prejpathmodel2 <- '
                # MEASUREMENT MODEL
                  agency_scale =~ agency1 + agency2 + agency3 + agency4
                  self_efficacy_scale =~ self_eff1 + self_eff2 + self_eff3 + self_eff4 + self_eff5 + self_eff6                   + self_eff7 + self_eff8
                  mental_wellness_scale =~ sdq1 + sdq2 + sdq3 + sdq4 + sdq5
                  risky_behaviour_scale =~ FRNSMKR5 + FRNALCR5 + YOUALCR5 + BEATEN + ARRSTDR5 + FRNGNGR5 +                      MEMGNGR5 + CRYWPNR5 + NUMPRTR5

      
                # STRUCTURAL MODEL
                  risky_behaviour_scale ~ self_efficacy_scale + mental_wellness_scale
                  mental_wellness_scale ~ self_efficacy_scale + agency_scale
                  self_efficacy_scale ~  agency_scale 
                  
                # CORRELATED ERRORS
                  risky_behaviour_scale	~~	mental_wellness_scale
                  risky_behaviour_scale	~~	self_efficacy_scale
      
               '
#Fitting and summarising model
 prejpathfit3 <- sem(prejpathmodel2, data = data)
      summary(prejpathfit3, fit.measures = T)

```
  Although the RMSEA, SRMR and AIC/BIC are suggestive of a better fitting model, the RMSEA p-value is 1???

Now plotting this model

```{r}

semPlot::semPaths(prejpathfit3, what = "est", layout = "spring")
```
With the correlated errors we can see that the riscky behaviour scale is not linked to any of the other variables
Let's see waht happens if the correlated errors are excluded
```{r}
prejpathmodel3 <- '
                # MEASUREMENT MODEL
                  agency_scale =~ agency1 + agency2 + agency3 + agency4
                  self_efficacy_scale =~ self_eff1 + self_eff2 + self_eff3 + self_eff4 + self_eff5 + self_eff6                   + self_eff7 + self_eff8
                  mental_wellness_scale =~ sdq1 + sdq2 + sdq3 + sdq4 + sdq5
                  risky_behaviour_scale =~ FRNSMKR5 + FRNALCR5 + YOUALCR5 + BEATEN + ARRSTDR5 + FRNGNGR5 +                      MEMGNGR5 + CRYWPNR5 + NUMPRTR5

      
                # STRUCTURAL MODEL
                  risky_behaviour_scale ~ self_efficacy_scale + mental_wellness_scale
                  mental_wellness_scale ~ self_efficacy_scale + agency_scale
                  self_efficacy_scale ~  agency_scale 
                  
               
               '
#Fitting and summarising model
 prejpathfit4 <- sem(prejpathmodel3, data = data)
      summary(prejpathfit4, fit.measures = T)

```
The summary is still the same as that of the previous model, now let's see the diagram

```{r}
semPlot::semPaths(prejpathfit4, what = "est", layout = "spring")
```
We can now see that the risky behaviour scale is now icluded in the relationship tree. The model shows that agency is a predictor of both self-efficacy and mental wellnenss, and mental illness is in tern a predictor of risky behaviour


                                Question 2
2.1
Loading datasets
```{r}
ethp  <- load("YL_June2017_Ethiopiadata_2017-09-08")
india <- load("YL_June2017_Indiadata_2017-11-22")
peru  <- load("YL_June2017_perudata_2017-11-12")
viet  <- load("YL_June2017_Vietnamdata_2017-11-01")
```
Now merging datasets

```{r}
remove(alldata)
```
```{r message = FALSE}
mylist <- list( one=Ethiopia.dat, two=India.dat, three=peru.dat, four= Vietnam.dat )
joined <- join_all( mylist, type="full" ) 
```

